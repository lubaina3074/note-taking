<!DOCTYPE html>

<html lang="en">
<%- include('base', { title: 'All your notes' , }); %>

  <body>
    <h2 style="color: white">Upload in md format!</h2>

    <form action="/notes/upload" enctype="multipart/form-data" method="post">
      <div class="form-group">
        <input type="file" class="form-control-file" name="myFile" />
        <input type="submit" value="Submit" class="btn btn-default" />
      </div>
    </form>

    <button type="button" id="folderBtn">Create new Folder</button>

    <button style="display: none" id="Addbtn">Add to Folder</button>


    <div class="file-list">

      <!-- Folders Section -->
      <ul class="folder-list">
        <% if (folderArray && folderArray.length> 0) { %>
          <% folderArray.forEach(function(folder) { %>
            <li class="folder-item" data-folder-id="<%= folder._id %>">
              <img src="/images/folder.png" class="folder-img" id="folderImg" />
                <%= folder.name %>
            </li>
            <% }) %>
              <% } else { %>

                <% } %>
      </ul>

      <!-- Files section -->

        <% if (fileArray && fileArray.length> 0) { %>
          <% fileArray.forEach(function(file) { %>
            <% if (file && !file.metadata.folderId) { %>
              <% const fileIdString=file._id.toString(); %>
                <% const uniqueId=file.metadata.uniqueId; %>
                  <li id="file-<%= file._id %>" class="file-li">
                    <div class="file-item" id="file-<%= file._id %>" draggable="true"
                      ondragstart="dragstartHandler(event)">
                     
                      <a id="file-link-<%= fileIdString %>" href="#" class="file-double-click-trigger"
                        data-unique-id="<%= uniqueId %>">
                        <img src="/images/file.png" alt="file" class="file-img" />
                      </a>
                      <%= file.filename %>
                    </div>
                  </li>

                  <% } %>
                    <% }) %>
                      <% } %>
      </ul>
  </body>

  <script>

    function dragstartHandler(ev) {
      const fileItem = ev.currentTarget;
      const uniqueId = fileItem.querySelector('.file-double-click-trigger').dataset.uniqueId;
      ev.dataTransfer.setData('text/plain', uniqueId);
    }

    function dragoverHandler(ev) {
      ev.preventDefault();
    }

    document.getElementById("folderBtn").onclick = async () => {
      const folderName = prompt("Enter folder name");
      if (!folderName) return;

      const response = await fetch("/notes/create-folder", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ name: folderName }),
      });

      const data = await response.json();
      if (data.success) {
        alert("Folder created!");
        window.location.reload();
      }
    };

    document.querySelectorAll('.file-double-click-trigger').forEach(el => {
      el.addEventListener('dblclick', function () {
        const uniqueId = this.dataset.uniqueId;
        location.href = '/notes/edit/' + uniqueId;
      })
    })

    document.querySelectorAll(".folder-item").forEach(el => {
      el.addEventListener('dblclick', function () {
        const folderId = this.dataset.folderId;
        location.href = '/notes/folder/' + folderId;
      })
    })

    document.querySelectorAll('.folder-item').forEach(folder => {
      folder.addEventListener('dragover', e => e.preventDefault());
      folder.addEventListener('drop', async e => {
        e.preventDefault();
        const fileUniqueId = e.dataTransfer.getData('text/plain');
        const folderId = folder.dataset.folderId;
        const response = await fetch('/notes/add-file-to-folder', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ uniqueId: fileUniqueId, folderId })
        });

        const data = await response.json();
        if (data.success) {
          alert('File added to folder!');
          const fileElement = document.querySelector(`[data-unique-id="${fileUniqueId}"]`
          ).closest('.file-item');
          if (fileElement)
          {
            fileElement.remove();
          } else {
            alert('Failed to add file to folder.');
          }
        }
      })
    })



  </script>

</html>